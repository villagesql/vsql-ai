# Test Anthropic provider for vsql_ai extension

# Install extension
INSTALL EXTENSION vsql_ai;

# Test with invalid API key - should return NULL with error warning
SELECT LENGTH(vsql_ai.ai_prompt('anthropic', 'claude-sonnet-4-5-20250929', 'invalid_key_12345', 'Hello')) IS NULL AS invalid_key_returns_null;

# Test with real API key if ANTHROPIC_API_KEY environment variable is set
if ($ANTHROPIC_API_KEY) {
  --echo # Testing with real Anthropic API key (key hidden from output)

  # Hide the API key from the result file
  --disable_query_log
  --eval SET @api_key = '$ANTHROPIC_API_KEY'
  --enable_query_log

  # Simple prompt test - Claude should respond with SUCCESS
  SELECT vsql_ai.ai_prompt('anthropic', 'claude-sonnet-4-5-20250929', @api_key, 'Say only the word: SUCCESS') LIKE '%SUCCESS%' AS contains_success;

  # Verify we got a non-empty response
  SELECT LENGTH(vsql_ai.ai_prompt('anthropic', 'claude-sonnet-4-5-20250929', @api_key, 'Reply with just: OK')) > 0 AS got_response;
}

if (!$ANTHROPIC_API_KEY) {
  --echo # Skipping live API test - ANTHROPIC_API_KEY not set
  --echo # To test with real API: export ANTHROPIC_API_KEY=your-key
}

# Cleanup
UNINSTALL EXTENSION vsql_ai;
